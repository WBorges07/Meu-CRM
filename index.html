<!DOCTYPE html>
<html lang="pt-br" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Jur√≠dico Pro - Gest√£o Elite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent-blue: #38bdf8;
            --accent-green: #10b981;
            --text-main: #f1f5f9;
            --border-color: #334155;
            --input-bg: #0f172a;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .navbar { background-color: var(--card-dark) !important; border-bottom: 1px solid var(--border-color); padding: 1rem 0; }
        
        /* --- DASHBOARD: QUADRADOS LADO A LADO --- */
        .stat-card { 
            background-color: var(--card-dark); 
            border: 1px solid var(--border-color); 
            border-radius: 16px; 
            padding: 2rem 1.5rem; 
            text-align: center; 
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
            box-shadow: 0 10px 20px -5px rgba(56, 189, 248, 0.2);
        }

        .stat-value { 
            font-size: 1.75rem; 
            font-weight: 800; 
            color: var(--accent-blue); 
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .stat-label { 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #94a3b8; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }

        /* Cores espec√≠ficas conforme as imagens */
        .card-total .stat-value { color: #38bdf8; }
        .card-ganhas .stat-value { color: #38bdf8; } /* Azul conforme imagem 38f7aa */
        .card-andamento .stat-value { color: #38bdf8; }
        .card-negociacao .stat-value { color: #38bdf8; }

        /* --- FORMUL√ÅRIO E TABELA --- */
        .form-section { background-color: var(--card-dark); border-radius: 16px; border: 1px solid var(--border-color); padding: 2.5rem; margin-bottom: 2rem; }
        .custom-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }

        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 0.8rem 1rem;
            border-radius: 10px;
        }

        .btn-cadastrar {
            background: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
            border: none; color: white; font-weight: 700; border-radius: 10px; padding: 0.8rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s;
        }

        .table-container { background-color: var(--card-dark); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; }
        .table { width: 100%; color: var(--text-main); table-layout: fixed; }
        .table thead th { background-color: #020617; color: #94a3b8; padding: 1.2rem 1rem; font-size: 0.75rem; text-transform: uppercase; }
        
        .input-valor-tabela {
            background: transparent; border: 1px solid transparent; color: white;
            font-weight: 700; width: 100%; padding: 4px; border-radius: 4px;
        }
        .input-valor-tabela:focus { background: var(--input-bg); border-color: var(--accent-blue); outline: none; }

        .select-status {
            appearance: none; border-radius: 50px; padding: 6px 12px;
            font-size: 0.75rem; font-weight: 800; cursor: pointer; width: 100%; text-align: center;
        }
        .select-status option { background-color: #0f172a; color: white; }

        .status-yellow { background-color: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .status-blue { background-color: rgba(56, 189, 248, 0.2); color: #7dd3fc; }
        .status-green { background-color: rgba(16, 185, 129, 0.2); color: #34d399; }

        .search-wrapper { position: relative; }
        .input-busca { padding-left: 40px !important; background-color: #1e293b !important; }
    </style>
</head>
<body class="notranslate">

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid px-5">
        <span class="navbar-brand fw-bold">‚öñ CRM <span style="color: var(--accent-blue)">ELITE</span></span>
        <button id="btnSair" class="btn btn-outline-danger btn-sm px-4 rounded-pill">Sair</button>
    </div>
</nav>

<div class="container-fluid px-5">
    
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card card-total">
                <div class="stat-value" id="valTotal">R$ 0,00</div>
                <div class="stat-label">Carteira Total</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card-ganhas">
                <div class="stat-value" id="valGanhos">R$ 0,00</div>
                <div class="stat-label">Causas Ganhas</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card-andamento">
                <div class="stat-value" id="valAndamento">R$ 0,00</div>
                <div class="stat-label">Em Andamento</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card-negociacao">
                <div class="stat-value" id="valNegociacao">R$ 0,00</div>
                <div class="stat-label">Em Negocia√ß√£o</div>
            </div>
        </div>
    </div>

    <div class="form-section shadow-lg">
        <h5 class="text-white fw-bold mb-4">üìÇ Novo Registro</h5>
        <div class="row g-4">
            <div class="col-md-3"><label class="custom-label">Nome</label><input type="text" id="nome" class="form-control"></div>
            <div class="col-md-3"><label class="custom-label">CPF / CNPJ</label><input type="text" id="cpf" class="form-control"></div>
            <div class="col-md-3"><label class="custom-label">WhatsApp</label><input type="text" id="contato" class="form-control"></div>
            <div class="col-md-3"><label class="custom-label">E-mail</label><input type="email" id="email" class="form-control"></div>
            <div class="col-md-4"><label class="custom-label">Valor (R$)</label><input type="text" id="valorCausa" class="form-control" placeholder="R$ 0,00"></div>
            <div class="col-md-4">
                <label class="custom-label">Status</label>
                <select id="situacao" class="form-select">
                    <option value="Em negocia√ß√£o">Em negocia√ß√£o</option>
                    <option value="Em andamento">Em andamento</option>
                    <option value="Causa ganha">Causa ganha</option>
                    <option value="Causa perdida">Causa perdida</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="btnSalvar" class="btn btn-cadastrar w-100">SALVAR PROCESSO</button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 search-wrapper">
            <span style="position:absolute; left:15px; top:12px">üîç</span>
            <input type="text" id="inputBusca" class="form-control input-busca" placeholder="Pesquisar na base de dados...">
        </div>
    </div>

    <div class="table-container">
        <table class="table table-dark table-hover align-middle">
            <thead>
                <tr>
                    <th style="width: 10%" class="ps-4">Data</th>
                    <th style="width: 20%">Cliente</th>
                    <th style="width: 15%">Contato</th>
                    <th style="width: 15%">Valor (R$)</th>
                    <th style="width: 15%">Situa√ß√£o</th>
                    <th style="width: 5%" class="text-center">A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="listaClientes"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db, auth } from './firebase.js';
    import { collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "login.html"; });

    // M√°scaras e Formata√ß√£o
    const maskCPF = IMask(document.getElementById('cpf'), { mask: [{ mask: '000.000.000-00' }, { mask: '00.000.000/0000-00' }] });
    const maskTelefone = IMask(document.getElementById('contato'), { mask: '(00) 00000-0000' });
    const maskValor = IMask(document.getElementById('valorCausa'), {
        mask: 'R$ num',
        blocks: { num: { mask: Number, thousandsSeparator: '.', padFractionalZeros: true, radix: ',', mapToRadix: ['.'] } }
    });

    const formatarMoeda = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    // Salvar no Firebase
    document.getElementById('btnSalvar').addEventListener('click', async () => {
        const nome = document.getElementById('nome').value;
        if(!nome) return alert("Nome √© obrigat√≥rio");
        try {
            await addDoc(collection(db, "clientes"), {
                data: new Date().toLocaleDateString('pt-BR'),
                nome, cpf: maskCPF.value, contato: maskTelefone.value, email: document.getElementById('email').value,
                valorCausa: maskValor.unmaskedValue ? parseFloat(maskValor.unmaskedValue) : 0,
                situacao: document.getElementById('situacao').value,
                timestamp: Date.now()
            });
            ['nome', 'cpf', 'contato', 'email', 'valorCausa'].forEach(id => document.getElementById(id).value = '');
            maskCPF.value = ''; maskTelefone.value = ''; maskValor.value = '';
        } catch (e) { alert("Erro ao salvar"); }
    });

    // Atualiza√ß√£o em tempo real
    window.atualizarDado = async (id, campo, valor) => {
        let vFinal = valor;
        if(campo === 'valorCausa') vFinal = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        await updateDoc(doc(db, "clientes", id), { [campo]: vFinal });
    };

    let todosOsDados = [];
    onSnapshot(query(collection(db, "clientes"), orderBy("timestamp", "desc")), (snapshot) => {
        todosOsDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizar();
    });

    document.getElementById('inputBusca').addEventListener('input', renderizar);

    function renderizar() {
        const termo = document.getElementById('inputBusca').value.toLowerCase();
        const lista = document.getElementById('listaClientes');
        lista.innerHTML = "";
        let vTotal = 0, vGanhos = 0, vAndamento = 0, vNegociacao = 0;

        todosOsDados.filter(c => c.nome.toLowerCase().includes(termo)).forEach((c) => {
            const valor = c.valorCausa || 0;
            vTotal += valor;
            if (c.situacao === 'Causa ganha') vGanhos += valor;
            else if (c.situacao === 'Em andamento') vAndamento += valor;
            else if (c.situacao === 'Em negocia√ß√£o') vNegociacao += valor;

            lista.innerHTML += `
                <tr>
                    <td class="ps-4 small text-secondary">${c.data}</td>
                    <td class="fw-bold">${c.nome}</td>
                    <td class="small">${c.contato || '---'}</td>
                    <td>
                        <input type="text" class="input-valor-tabela" value="${formatarMoeda(valor)}" 
                            onblur="window.atualizarDado('${c.id}', 'valorCausa', this.value)">
                    </td>
                    <td>
                        <select class="select-status ${c.situacao === 'Causa ganha' ? 'status-green' : c.situacao === 'Em negocia√ß√£o' ? 'status-yellow' : 'status-blue'}" 
                            onchange="window.atualizarDado('${c.id}', 'situacao', this.value)">
                            <option value="Em negocia√ß√£o" ${c.situacao === 'Em negocia√ß√£o' ? 'selected' : ''}>Negocia√ß√£o</option>
                            <option value="Em andamento" ${c.situacao === 'Em andamento' ? 'selected' : ''}>Andamento</option>
                            <option value="Causa ganha" ${c.situacao === 'Causa ganha' ? 'selected' : ''}>Ganha</option>
                        </select>
                    </td>
                    <td class="text-center"><button onclick="window.excluir('${c.id}')" class="btn btn-sm text-danger">‚úï</button></td>
                </tr>
            `;
        });

        document.getElementById('valTotal').innerText = formatarMoeda(vTotal);
        document.getElementById('valGanhos').innerText = formatarMoeda(vGanhos);
        document.getElementById('valAndamento').innerText = formatarMoeda(vAndamento);
        document.getElementById('valNegociacao').innerText = formatarMoeda(vNegociacao);
    }

    window.excluir = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "clientes", id)); };
    document.getElementById('btnSair').onclick = () => signOut(auth);
</script>
</body>
</html>