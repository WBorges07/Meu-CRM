<!DOCTYPE html>
<html lang="pt-br" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Jur√≠dico Pro - Gest√£o Elite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root {
            --bg-dark: #020617;
            --card-dark: #0f172a;
            --accent-blue: #38bdf8;
            --accent-glow: #0ea5e9;
            --text-main: #f1f5f9;
            --border-color: #1e293b;
            --input-bg: #020617;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; }
        .navbar { background-color: var(--card-dark) !important; border-bottom: 1px solid var(--border-color); padding: 1rem 0; }
        
        /* DASHBOARD INDICADORES */
        .dashboard-row { display: flex; gap: 1.5rem; margin-bottom: 3rem; flex-wrap: wrap; }
        .stat-card { 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem 1.5rem; 
            text-align: center; flex: 1; min-width: 220px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        .stat-card:hover { transform: translateY(-8px); border-color: var(--accent-blue); box-shadow: 0 15px 35px -5px rgba(14, 165, 233, 0.2); }
        .stat-value { font-size: 1.8rem; font-weight: 900; background: linear-gradient(to right, #fff, var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; display: block; }
        .stat-label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMUL√ÅRIO */
        .form-section { background-color: var(--card-dark); border-radius: 16px; border: 1px solid var(--border-color); padding: 2rem; margin-bottom: 2rem; }
        .custom-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
        .form-control, .form-select { background-color: var(--input-bg); border: 1px solid var(--border-color); color: white; border-radius: 10px; height: 42px; font-size: 0.9rem; }

        /* BOT√ÉO SALVAR COMPACTO */
        .btn-salvar-pro {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-glow));
            color: #020617; border: none; border-radius: 10px;
            padding: 0 25px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
            height: 42px; width: auto; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-salvar-pro:hover { transform: translateY(-1px); filter: brightness(1.1); }

        /* BOT√ïES MODERNOS (GLASSMORPHISM) COMPACTOS */
        .actions-wrapper { display: flex; gap: 12px; justify-content: flex-end; }
        .btn-modern-action {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff; padding: 0 20px; border-radius: 12px;
            font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; transition: all 0.3s ease; height: 45px; width: auto; min-width: 140px;
        }
        .btn-modern-action:hover {
            background: rgba(255, 255, 255, 0.08); border-color: var(--accent-blue);
            color: var(--accent-blue); transform: translateY(-2px);
        }
        .btn-excel-modern { border-color: rgba(16, 185, 129, 0.3); }
        .btn-excel-modern:hover { border-color: #10b981; color: #10b981; }

        /* TABELA */
        .table-container { background-color: var(--card-dark); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; }
        .table { width: 100%; color: var(--text-main); font-size: 0.85rem; }
        .table thead th { background-color: #020617; color: #94a3b8; padding: 1.2rem 1rem; font-size: 0.7rem; text-transform: uppercase; }
        
        .select-status {
            appearance: none; background-color: #020617; border: 1px solid var(--border-color);
            border-radius: 50px; padding: 5px 10px; font-size: 0.7rem; font-weight: 800; cursor: pointer; text-align: center;
        }
        .status-yellow { color: #fbbf24; } .status-blue { color: #38bdf8; } .status-green { color: #10b981; }

        .input-inline-tabela { background: transparent; border: 1px solid transparent; color: white; width: 100%; padding: 2px 5px; }
        .input-inline-tabela:focus { background: #020617; border-color: var(--accent-blue); outline: none; border-radius: 4px; }
        
        .input-busca { padding-left: 45px !important; background-color: #0f172a !important; border: 1px solid var(--border-color); color: white; border-radius: 12px; height: 45px; }
        .search-wrapper { position: relative; }
        .search-icon { position: absolute; left: 18px; top: 12px; color: var(--accent-blue); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid px-5">
        <span class="navbar-brand fw-bold">‚öñ CRM <span style="color: var(--accent-blue)">ELITE</span></span>
        <button id="btnSair" class="btn btn-outline-danger btn-sm px-4 rounded-pill">Sair</button>
    </div>
</nav>

<div class="container-fluid px-5">
    <div class="dashboard-row">
        <div class="stat-card"><span class="stat-value" id="valTotal">R$ 0,00</span><span class="stat-label">Carteira Total</span></div>
        <div class="stat-card"><span class="stat-value" id="valGanhos" style="background: linear-gradient(to right, #fff, #10b981); -webkit-background-clip: text;">R$ 0,00</span><span class="stat-label">Causas Ganhas</span></div>
        <div class="stat-card"><span class="stat-value" id="valAndamento">R$ 0,00</span><span class="stat-label">Em Andamento</span></div>
        <div class="stat-card"><span class="stat-value" id="valNegociacao" style="background: linear-gradient(to right, #fff, #fbbf24); -webkit-background-clip: text;">R$ 0,00</span><span class="stat-label">Em Negocia√ß√£o</span></div>
    </div>

    <div class="form-section">
        <div class="row g-3 align-items-end">
            <div class="col-md-1"><label class="custom-label">Contrato</label><input type="text" id="numContrato" class="form-control"></div>
            <div class="col-md-3"><label class="custom-label">Nome Cliente</label><input type="text" id="nome" class="form-control"></div>
            <div class="col-md-2"><label class="custom-label">Contato</label><input type="text" id="contato" class="form-control"></div>
            <div class="col-md-2"><label class="custom-label">E-mail</label><input type="email" id="email" class="form-control"></div>
            <div class="col-md-2"><label class="custom-label">Valor (R$)</label><input type="text" id="valorCausa" class="form-control" placeholder="R$ 0,00"></div>
            <div class="col-md-1">
                <label class="custom-label">Status</label>
                <select id="situacao" class="form-select">
                    <option value="Em negocia√ß√£o">Negocia√ß√£o</option>
                    <option value="Em andamento">Andamento</option>
                    <option value="Causa ganha">Ganha</option>
                </select>
            </div>
            <div class="col-md-1 text-end"><button id="btnSalvar" class="btn-salvar-pro">SALVAR</button></div>
        </div>
    </div>

    <div class="row mb-4 align-items-center">
        <div class="col-md-7">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="inputBusca" class="form-control input-busca" placeholder="Pesquisar por nome ou contrato...">
            </div>
        </div>
        <div class="col-md-5">
            <div class="actions-wrapper">
                <button id="btnExportar" class="btn-modern-action btn-excel-modern">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
                    Exportar
                </button>
                <a href="esteira.html" class="btn-modern-action">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    Ver Esteira
                </a>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-dark table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="ps-4">Data</th><th>Contrato</th><th>Cliente</th><th>Contato</th><th>E-mail</th><th>Valor</th><th>Situa√ß√£o</th><th class="text-center">A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="listaClientes"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db, auth } from './firebase.js';
    import { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "login.html"; });

    const maskValor = IMask(document.getElementById('valorCausa'), {
        mask: 'R$ num',
        blocks: { num: { mask: Number, thousandsSeparator: '.', padFractionalZeros: true, radix: ',', mapToRadix: ['.'] } }
    });
    IMask(document.getElementById('contato'), { mask: '(00) 00000-0000' });

    const formatarMoeda = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    document.getElementById('btnSalvar').onclick = async () => {
        const nome = document.getElementById('nome').value;
        if(!nome) return alert("Nome obrigat√≥rio");
        await addDoc(collection(db, "clientes"), {
            data: new Date().toLocaleDateString('pt-BR'),
            numContrato: document.getElementById('numContrato').value || '---',
            nome, contato: document.getElementById('contato').value || '---',
            email: document.getElementById('email').value || '---',
            valorCausa: maskValor.unmaskedValue ? parseFloat(maskValor.unmaskedValue) : 0,
            situacao: document.getElementById('situacao').value,
            timestamp: Date.now()
        });
        ['numContrato', 'nome', 'contato', 'email', 'valorCausa'].forEach(id => document.getElementById(id).value = '');
        maskValor.value = '';
    };

    window.atualizarDado = async (id, campo, valor) => {
        let vFinal = valor;
        if(campo === 'valorCausa') vFinal = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        await updateDoc(doc(db, "clientes", id), { [campo]: vFinal });
    };

    let todosOsDados = [];
    onSnapshot(query(collection(db, "clientes"), orderBy("timestamp", "desc")), (snapshot) => {
        todosOsDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizar();
    });

    function renderizar() {
        const termo = document.getElementById('inputBusca').value.toLowerCase();
        const lista = document.getElementById('listaClientes');
        lista.innerHTML = "";
        let vTotal = 0, vGanhos = 0, vAndamento = 0, vNegociacao = 0;

        todosOsDados.filter(c => c.nome.toLowerCase().includes(termo) || (c.numContrato && c.numContrato.includes(termo))).forEach((c) => {
            const valor = c.valorCausa || 0;
            vTotal += valor;
            if (c.situacao === 'Causa ganha') vGanhos += valor;
            else if (c.situacao === 'Em andamento') vAndamento += valor;
            else if (c.situacao === 'Em negocia√ß√£o') vNegociacao += valor;
            const statusClass = c.situacao === 'Causa ganha' ? 'status-green' : c.situacao === 'Em negocia√ß√£o' ? 'status-yellow' : 'status-blue';

            lista.innerHTML += `
                <tr>
                    <td class="ps-4 small text-secondary">${c.data}</td>
                    <td class="fw-bold text-info">${c.numContrato}</td>
                    <td>${c.nome}</td>
                    <td>${c.contato}</td>
                    <td class="small text-secondary">${c.email}</td>
                    <td class="fw-bold"><input type="text" class="input-inline-tabela" value="${formatarMoeda(valor)}" onblur="window.atualizarDado('${c.id}', 'valorCausa', this.value)"></td>
                    <td>
                        <select class="select-status ${statusClass}" onchange="window.atualizarDado('${c.id}', 'situacao', this.value)">
                            <option value="Em negocia√ß√£o" ${c.situacao === 'Em negocia√ß√£o' ? 'selected' : ''}>NEGOCIA√á√ÉO</option>
                            <option value="Em andamento" ${c.situacao === 'Em andamento' ? 'selected' : ''}>ANDAMENTO</option>
                            <option value="Causa ganha" ${c.situacao === 'Causa ganha' ? 'selected' : ''}>GANHA</option>
                        </select>
                    </td>
                    <td class="text-center"><button onclick="window.excluir('${c.id}')" class="btn btn-sm text-danger">‚úï</button></td>
                </tr>`;
        });
        document.getElementById('valTotal').innerText = formatarMoeda(vTotal);
        document.getElementById('valGanhos').innerText = formatarMoeda(vGanhos);
        document.getElementById('valAndamento').innerText = formatarMoeda(vAndamento);
        document.getElementById('valNegociacao').innerText = formatarMoeda(vNegociacao);
    }

    document.getElementById('btnExportar').onclick = () => {
        const ws = XLSX.utils.json_to_sheet(todosOsDados.map(c => ({ "Data": c.data, "Cliente": c.nome, "Valor": c.valorCausa, "Status": c.situacao })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "CRM");
        XLSX.writeFile(wb, "Relatorio_CRM.xlsx");
    };

    window.excluir = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, "clientes", id)); };
    document.getElementById('btnSair').onclick = () => signOut(auth);
</script>
</body>
</html>