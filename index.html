<!DOCTYPE html>
<html lang="pt-br" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Jur√≠dico Pro - Gest√£o Financeira</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent-blue: #38bdf8;
            --text-main: #f1f5f9;
            --border-color: #334155;
            --success-green: #10b981;
            --danger-red: #ef4444;
            --gold: #f59e0b;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar { background-color: var(--card-dark) !important; border-bottom: 1px solid var(--border-color); }
        
        /* Cards de Resumo Financeiro */
        .stat-card {
            background-color: var(--card-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            height: 100%;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--accent-blue); margin-top: 5px; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        .card { background-color: var(--card-dark); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-main); }
        .form-control, .form-select { background-color: #0f172a; border: 1px solid var(--border-color); color: white; }
        .table { color: var(--text-main); border-color: var(--border-color); }
        
        .badge-status { padding: 0.5em 0.8em; border-radius: 6px; }
    </style>
</head>
<body class="notranslate">

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold"><span style="color: var(--accent-blue)">‚öñ</span> CRM Jur√≠dico & Financeiro</span>
        <button id="btnSair" class="btn btn-outline-danger btn-sm">Sair</button>
    </div>
</nav>

<div class="container">
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total em Processos</div>
                <div id="valTotal" class="stat-value text-white">R$ 0,00</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">üí∞ Causas Ganhas</div>
                <div id="valGanhos" class="stat-value" style="color: var(--success-green)">R$ 0,00</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">‚è≥ Em Andamento</div>
                <div id="valAndamento" class="stat-value" style="color: var(--accent-blue)">R$ 0,00</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">üìâ Causas Perdidas</div>
                <div id="valPerdidas" class="stat-value" style="color: var(--danger-red)">R$ 0,00</div>
            </div>
        </div>
    </div>

    <div class="card p-4 mb-4 shadow-lg">
        <h5 class="mb-4 fw-bold" style="color: var(--accent-blue)">Novo Registro com Valor da Causa</h5>
        <div class="row g-3">
            <div class="col-md-4"><input type="text" id="nome" class="form-control" placeholder="Nome do Cliente"></div>
            <div class="col-md-4"><input type="text" id="numProcesso" class="form-control" placeholder="N¬∞ do Processo"></div>
            <div class="col-md-4"><input type="number" id="valorCausa" class="form-control" placeholder="Valor da Causa (Ex: 5000)"></div>
            
            <div class="col-md-3">
                <select id="status" class="form-select">
                    <option value="Em negocia√ß√£o">Em negocia√ß√£o</option>
                    <option value="Contrato assinado">Contrato assinado</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="situacao" class="form-select">
                    <option value="Em andamento">Em andamento</option>
                    <option value="Causa ganha">Causa ganha</option>
                    <option value="Causa perdida">Causa perdida</option>
                </select>
            </div>
            <div class="col-md-3"><input type="text" id="telefone" class="form-control" placeholder="Contato"></div>
            <div class="col-md-3">
                <button id="btnSalvar" class="btn btn-primary w-100 fw-bold">Salvar Registro</button>
            </div>
        </div>
    </div>

    <div class="card p-0 shadow-lg overflow-hidden border-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">Data</th>
                        <th>Cliente</th>
                        <th>Processo</th>
                        <th>Valor (R$)</th>
                        <th>Situa√ß√£o</th>
                        <th class="pe-4 text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaClientes" class="align-middle"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { db, auth } from './firebase.js';
    import { collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "login.html";
    });

    const formatarMoeda = (valor) => {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    };

    // Salvar
    document.getElementById('btnSalvar').addEventListener('click', async () => {
        const valorInput = document.getElementById('valorCausa').value;
        try {
            await addDoc(collection(db, "clientes"), {
                data: new Date().toLocaleDateString('pt-BR'),
                nome: document.getElementById('nome').value,
                numProcesso: document.getElementById('numProcesso').value,
                valorCausa: parseFloat(valorInput) || 0,
                status: document.getElementById('status').value,
                situacao: document.getElementById('situacao').value,
                telefone: document.getElementById('telefone').value,
                timestamp: Date.now()
            });
            alert("Registro Salvo!");
            document.getElementById('valorCausa').value = '';
            document.getElementById('nome').value = '';
            document.getElementById('numProcesso').value = '';
        } catch (e) { alert("Erro ao salvar."); }
    });

    // Dashboard e Tabela em Tempo Real
    const q = query(collection(db, "clientes"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        let listaHTML = "";
        let vTotal = 0, vGanhos = 0, vAndamento = 0, vPerdidas = 0;

        snapshot.forEach((docSnap) => {
            const c = docSnap.data();
            const valor = c.valorCausa || 0;
            
            vTotal += valor;
            if (c.situacao === 'Causa ganha') vGanhos += valor;
            else if (c.situacao === 'Em andamento') vAndamento += valor;
            else if (c.situacao === 'Causa perdida') vPerdidas += valor;

            const badgeSituacao = c.situacao === 'Causa ganha' ? 'bg-success' : (c.situacao === 'Causa perdida' ? 'bg-danger' : 'bg-info text-dark');

            listaHTML += `
                <tr>
                    <td class="ps-4 small text-secondary">${c.data}</td>
                    <td class="fw-bold">${c.nome}</td>
                    <td class="small font-monospace">${c.numProcesso}</td>
                    <td class="text-info fw-bold">${formatarMoeda(valor)}</td>
                    <td><span class="badge ${badgeSituacao}">${c.situacao}</span></td>
                    <td class="pe-4 text-center">
                        <button onclick="window.excluir('${docSnap.id}')" class="btn btn-sm btn-link text-danger text-decoration-none">Apagar</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('listaClientes').innerHTML = listaHTML;
        document.getElementById('valTotal').innerText = formatarMoeda(vTotal);
        document.getElementById('valGanhos').innerText = formatarMoeda(vGanhos);
        document.getElementById('valAndamento').innerText = formatarMoeda(vAndamento);
        document.getElementById('valPerdidas').innerText = formatarMoeda(vPerdidas);
    });

    window.excluir = async (id) => {
        if(confirm("Eliminar este registro?")) await deleteDoc(doc(db, "clientes", id));
    };

    document.getElementById('btnSair').onclick = () => signOut(auth);
</script>
</body>
</html>